---
title: "fisheryO: Catch Overview"
author: ""
date: '`r strftime(Sys.time(), format = "%d %B %Y")`'
output:
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{"fisheryO: Catch Overview"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
[<img align="right" alt="ICES Logo" width="17%" height="17%" src="http://www.ices.dk/_layouts/15/1033/images/icesimg/iceslogo.png">](http://www.ices.dk/Pages/default.aspx) 

# Catch Overview 


## Introduction
[Catch Statistics](http://ices.dk/marine-data/dataset-collections/Pages/Fish-catch-and-stock-assessment.aspx) are submitted by 20 ICES member countries and are collected and coordinated in collaboration with the Statistical Office of the European Communities (EUROSTAT). These data are provided by ICES as Official Nominal Catches (2006-2014) and Historical Nominal Catches (2005-2010). To understand how fishing patterns have changed over time, it is useful to calculate a time series of total catch by country and species for each ecoregion. Member countries have reported these data at different spatial and taxonomic designations over time and several steps need to be taken to create a homologous dataset.

## Download Data and house-keeping
```{r DataDownload, include = TRUE, message = FALSE}

library(dplyr, quietly = TRUE)
library(tidyr, quietly = TRUE)
library(reshape2, quietly = TRUE)
library(ggplot2, quietly = TRUE)
library(knitr, quietly = TRUE)
library(gridExtra, quietly = TRUE)
library(dygraphs, quietly = TRUE)
library(xts, quietly = TRUE)
# 
options(scipen = 5)
# 
baseLoc <- system.file(package = "fisheryO")
extPath <- file.path(baseLoc, "extdata")
# 
# 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
# DATA SOURCE: ICES official catch statistics #
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
historicURL <- "http://ices.dk/marine-data/Documents/CatchStats/HistoricalLandings1950-2010.zip"
tmpFileHistoric <- tempfile(fileext = ".zip")
download.file(historicURL, destfile = tmpFileHistoric, mode = "wb", quiet = TRUE)
catchDat1950 <- read.csv(unz(tmpFileHistoric,
                             "ICES_1950-2010.csv"),
                         stringsAsFactors = FALSE, header = TRUE, fill = TRUE, 
                         na.strings = c("...", "-", "ns", "."))
# 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
# DATA SOURCE: ICES official catch statistics (2006-2014) #
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
catchURL <- "http://ices.dk/marine-data/Documents/CatchStats/OfficialNominalCatches.zip"
tmpFileCatch <- tempfile(fileext = ".zip")
download.file(catchURL, destfile = tmpFileCatch, mode = "wb", quiet = TRUE)
catchDat2010 <- read.csv(unz(tmpFileCatch,
                             "ICESCatchDataset2006-2014.csv"),
                         stringsAsFactors = FALSE, header = TRUE, fill = TRUE)
```

## Data manipulation
To manipulate these raw data into something useable, "helper" files are downloaded 

* spList - [FAO ASFIS species list](http://www.fao.org/fishery/collection/asfis/en)

```{r WebHelpers, include = TRUE}
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
# DATA SOURCE: FAO species names and labels #
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
spURL <- "ftp://ftp.fao.org/FI/STAT/DATA/ASFIS_sp.zip"
tmpFileSp <- tempfile(fileext = ".zip")
download.file(spURL, destfile = tmpFileSp, mode = "wb", quiet = TRUE)
spList <- read.delim(unz(tmpFileSp,
                         "ASFIS_sp_Feb_2016.txt"), 
                     fill = TRUE,
                     stringsAsFactors = FALSE, header = TRUE)
# 
spList <- spList %>%
  select(X3A_CODE, 
         Scientific_name, 
         English_name)
```

A few other "helper" files have been created and are found in "extdata" folder within 'fisheryO' package. (SL- create a link to the R script when possible)

* areaID - Manually creates a link between ICES Ecoregions and the area designations found in the STECF effort and ICES catch databases
* historicID - Links the historic area names to modern ICES names. Note, the level of aggregation remains at the historic level.
* countryNames - Cleans up discrepancies between ICES and STECF country codes and corrects them to the ISO standards

```{r LocalHelpers, include = TRUE}
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
# DATA SOURCE:STECF effort and ICES catch databases #
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #

#(NOTE: this file was created manually - with stock list database this should not be necessary - SL)
areaDat <- read.csv("~/git/ices-dk/fisheryO/inst/extdata/areaList.csv",
                   stringsAsFactors = FALSE)

areaID <- areaDat %>%
  filter(areaType %in% c("historicArea", "ICESarea"),
         FO2016 == TRUE) %>%
  select(-ICESarea)
 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
# CODE TO CREATE FILE: fisheryO/R/FisheriesAdvice/historicAreas.R #
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
historicID <- read.csv("~/git/ices-dk/fisheryO/inst/extdata/historicAreas_with_ICESAreas.csv", 
                       stringsAsFactors = FALSE)
 
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
# CODE TO CREATE FILE: fisheryO/R/FisheriesAdvice/countryNames.R #
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
countryNames <- read.csv("~/git/ices-dk/fisheryO/inst/extdata/countryNames.csv",
                         stringsAsFactors = FALSE)

countryNames <- countryNames %>%
  filter(VARIABLE %in% c("historicNames", "catchNames"))
```


```{r SelectAreas, include = TRUE}
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
# Data cleaning and aggregating #
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #
# 
catchAreaID <- areaID %>%
  filter(areaType == "ICESarea") %>%
  mutate(value = tolower(value),
         value = gsub("_nk", "_NK", value))
 
```


```{r AggregateRecentData, include = TRUE}
catchDat2010Clean <- catchDat2010 %>%
  Filter(f = function(x)!all(is.na(x))) %>% # Get rid of extra columns of NA
  select(-Units,
         ICES_Area = Area) %>%
  melt(id.vars = c("Species", "ICES_Area", "Country"), # Turn into a long data frame
       variable.name = "YEAR",
       value.name = "VALUE") %>%
  mutate(YEAR = as.numeric(gsub("X", "", YEAR)),
         VALUE = as.numeric(VALUE)) %>% 
  full_join(spList, c("Species" = "X3A_CODE")) %>% # merge with FAO species names
  full_join(countryNames, c("Country" = "VALUE")) %>% # merge with ISO country names
  full_join(catchAreaID, c("ICES_Area" = "value")) %>% # Merge to add ecoregions (only areas defined in catchAreaID!)
  filter(ICES_Area %in% catchAreaID$value) %>% 
  select(YEAR, 
         ECOREGION = Ecoregion,
         COUNTRY,
         ISO3,
         SPECIES_NAME = Scientific_name,
         COMMON_NAME = English_name,
         SPECIES_CODE = Species,
         ICES_Area,
         VALUE)

```

```{r AggregateHistoricData, include = TRUE}
# 
catchDat1950Clean <- catchDat1950 %>%
  melt(id.vars = c("Country", "Species", "Division"),
       variable.name = "YEAR", 
       value.name = "VALUE") %>%
  rename(historicName = Division) %>%
  mutate(YEAR = as.numeric(gsub("X", "", YEAR))) %>% # Clean up YEAR and make VALUE numeric
  filter(YEAR <= 2005) %>%
  left_join(y = spList, c("Species" = "English_name")) %>% # Merge to add FAO species information
  left_join(y = spList, c("Species" = "Scientific_name",   # Merge to add FAO species information
                          "X3A_CODE")) %>%
  left_join(y = historicID, c("historicName" = "historicName")) %>% # Merge to add information on ICES Areas
  left_join(y = areaID, c("historicName" = "value")) %>% # Merge to add ecoregions
  left_join(y = countryNames, c("Country" = "VALUE")) %>% # Merge to add consistent country codes
  select(YEAR, 
         ECOREGION = Ecoregion,# Grab necessary columns and rename accordingly
         COUNTRY, ISO3, 
         SPECIES_NAME = Scientific_name, 
         COMMON_NAME = Species,
         SPECIES_CODE = X3A_CODE,
         ICES_Area, Area,
         Subarea, Division,
         Subdivision, Unit,
         VALUE) %>%
  mutate(VALUE = ifelse(VALUE == "<0.5",
                        as.numeric(0.5),
                        VALUE),
         VALUE = ifelse(!is.na(VALUE),
                        as.numeric(VALUE),
                        NA),
         # Correct the historic species names with the FAO species names
         SPECIES_NAME = recode(SPECIES_NAME, "Northern bluefin tuna" = "Atlantic bluefin tuna" ),
         SPECIES_NAME = recode(SPECIES_NAME, "Cuttlefish,bobtail squids nei" ="Cuttlefish,bobtail squids nei"),
         SPECIES_NAME = recode(SPECIES_NAME, "Razor clams nei" = "Razor clams, knife clams nei"),
         SPECIES_NAME = recode(SPECIES_NAME, "Thickback soles" = "Thickback soles nei"),
         SPECIES_NAME = recode(SPECIES_NAME, "Atlantic blue marlin" = "Blue marlin"),
         SPECIES_NAME = recode(SPECIES_NAME, "Canary drum (=Baardman)" = "Canary drum(=Baardman)"),
         SPECIES_NAME = recode(SPECIES_NAME, "Chub mackerel" = "Atlantic chub mackerel"),
         SPECIES_NAME = recode(SPECIES_NAME, "Eagle rays" = "Eagle rays nei"),
         SPECIES_NAME = recode(SPECIES_NAME, "Squids nei" = "Common squids nei"),
         SPECIES_NAME = recode(SPECIES_NAME, "St. Pauls fingerfin" = "St. Paul's fingerfin"),
         SPECIES_NAME = recode(SPECIES_NAME, "Knife-nosed chimaeras" = "Knife-nosed chimaeras nei"),
         SPECIES_NAME = recode(SPECIES_NAME, "Hairtails, cutlassfishes nei" = "Hairtails, scabbardfishes nei"),
         SPECIES_NAME = recode(SPECIES_NAME, "Houndsharks,smoothhounds nei" = "Houndsharks, smoothhounds nei"),
         SPECIES_NAME = recode(SPECIES_NAME, "Horse mussels" = "Horse mussels nei"),
         SPECIES_NAME = recode(SPECIES_NAME, "Wels(=Som)catfish" = "Wels(=Som) catfish"),
         SPECIES_NAME = recode(SPECIES_NAME, "Goose barnacles" = "Goose barnacles nei"),
         SPECIES_NAME = recode(SPECIES_NAME, "Mediterranean rainbow wrasse" = "Rainbow wrasse"),
         SPECIES_NAME = recode(SPECIES_NAME, "Morays" = "Morays nei"),
         SPECIES_NAME = recode(SPECIES_NAME, "Sockeye(=Red)salmon" = "Sockeye(=Red) salmon"),
         SPECIES_NAME = recode(SPECIES_NAME, "Swimcrabs nei" = "Callinectes swimcrabs nei"),
         SPECIES_NAME = recode(SPECIES_NAME, "Pink(=Humpback)salmon" = "Pink(=Humpback) salmon"),
         SPECIES_NAME = recode(SPECIES_NAME, "Striped mullet" = "Red mullet")) %>%
  select(-Area, -Subarea, -Division, -Subdivision, -Unit) %>%
  filter(ECOREGION != "ALL")
 
```



```{r DataMerge}
allDat <- catchDat2010Clean %>%
  bind_rows(catchDat1950Clean)
```



```{r areaPlot, include = TRUE}
icesAreaPlot <- function(area = unique(allDat$ECOREGION)[1],
                         IA,
                         type = c("COMMON_NAME", "COUNTRY")[1],
                         fig.save = FALSE,
                         fig.plot = TRUE) {
  # 
  # library(gridExtra)
  # 
  iaDat <- allDat[allDat[[area]] == IA,] 
  # for(type in c("COMMON_NAME", "COUNTRY")) {
    # 
    dots <- lapply(c(type, area, "YEAR"), as.symbol)
    catchPlot <- iaDat %>%
      group_by_(.dots = dots[1]) %>%
      dplyr::summarize(typeTotal = sum(VALUE, na.rm = TRUE)) %>% # Overall catch to order plot
      arrange(-typeTotal) %>%
      filter(typeTotal >= 1) %>%
      dplyr::mutate(RANK = min_rank(desc(typeTotal))) %>%
      inner_join(iaDat, ifelse(type == "COMMON_NAME", 
                               c("COMMON_NAME" = "COMMON_NAME"),
                               c("COUNTRY" = "COUNTRY"))) %>%
      dplyr::mutate(COUNTRY = replace(COUNTRY, RANK > 10, "OTHER"),
                    COMMON_NAME = replace(COMMON_NAME, RANK > 10, "OTHER"),
                    COMMON_NAME = gsub("\\(=", " \\(", COMMON_NAME)) %>%
      group_by_(.dots = dots) %>%
      dplyr::summarize(typeTotal = sum(VALUE, na.rm = TRUE))
    # 
    catchPlot <- rbind(catchPlot[!catchPlot[[type]] == "OTHER",],
                       catchPlot[catchPlot[[type]] == "OTHER",])
    # 
    colList <- c("#DB9D85", "#C7A76C", "#ABB065", "#86B875", "#5CBD92",
                 "#39BEB1", "#4CB9CC", "#7DB0DD", "#ACA4E2", "#CD99D8")
    # 
     
    catchPlot[[type]] <- factor(catchPlot[[type]], levels = unique(catchPlot[[type]]))
    myColors <- colList[1:length(unique(catchPlot[[type]]))]
    names(myColors) <- levels(catchPlot[[type]])
    myColors["OTHER"] <- "grey40"
    # 
    if(type == "COUNTRY"){
      countryColors <- myColors
      pl <- ggplot(catchPlot, aes(x = YEAR, y = typeTotal)) +
        geom_area(aes_string(fill = type, color = type), alpha = .8, position = "stack") +
        scale_fill_manual(values = countryColors) +
        scale_color_manual(values = countryColors) +
        labs(title = gsub("27.", "", IA),
             x = "",
             y = "Landings (tonnes)",
             fill = "Country",
             color = "Country") +
        theme_bw(base_size = 9*(81/169))
      }
    if(type == "COMMON_NAME"){
      commonColors <- myColors
      pl <- ggplot(catchPlot, aes(x = YEAR, y = typeTotal)) +
        geom_area(aes_string(fill = type, color = type), alpha = .8, position = "stack") +
        scale_fill_manual(values = commonColors) +
        scale_color_manual(values = commonColors) +
        labs(title = gsub("27.", "", IA),
             x = "",
             y = "Landings (tonnes)",
             fill = "Species",
             color = "Species") +
             theme_bw(base_size = 9*(81/169))
    }
    # 
    if(fig.save == TRUE) {
      figName <- ifelse(type == "COUNTRY", "figure1_", "figure4_")
      # png(filename = paste0("~/git/ices-dk/fisheryO/output/", figName, IA, ".png"),
      #     width = 6.5,
      #     height = 6.5,
      #     units = "in",
      #     res = 600)
      ggsave(filename = paste0("~/git/ices-dk/fisheryO/output/", figName, IA, ".png"),
             plot = pl, 
             width = 6.5,
          height = 6.5,
          units = "in",
          dpi = 600)
             
      # dev.off()
    }
    if(fig.plot == TRUE) {
      pl
    }
  # }
 # g <- grid.arrange(plCOUNTRY, plCOMMON, ncol = 2)
 # invisible(g)
}
```

## Catch by ecoregion, aggregated by country and species (dynamic plots)
Trace the plots to see annual landings for each aggregation. Click and highlight the time-series for a closer look and double-click to return to the original view.

```{r DynamicPlot, include = TRUE}
icesAreaDy <- function(area = unique(allDat$ECOREGION)[1],
                         IA) {
  # 
  colList <- c("#DB9D85", "#C7A76C", "#ABB065", "#86B875", "#5CBD92",
               "#39BEB1", "#4CB9CC", "#7DB0DD", "#ACA4E2", "#CD99D8")
  # 
  type = "COUNTRY"
  iaDat <- allDat[allDat[[area]] == IA,] 
  for(type in c("COMMON_NAME", "COUNTRY")) {
    # 
    dots <- lapply(c(type, area, "YEAR"), as.symbol)
    # dots2 <- lapply(c(type, "typeTotal", "YEAR"), as.symbol)
    #
    catchDy <- iaDat %>%
      group_by_(.dots = dots[1]) %>%
      dplyr::summarize(typeTotal = sum(VALUE, na.rm = TRUE)) %>% # Overall catch to order plot
      arrange(-typeTotal) %>%
      filter(typeTotal >= 1) %>%
      dplyr::mutate(RANK = min_rank(desc(typeTotal))) %>%
      inner_join(iaDat, ifelse(type == "COMMON_NAME", 
                               c("COMMON_NAME" = "COMMON_NAME"),
                               c("COUNTRY" = "COUNTRY"))) %>%
      dplyr::mutate(COUNTRY = replace(COUNTRY, RANK > 10, "OTHER"),
                    COMMON_NAME = replace(COMMON_NAME, RANK > 10, "OTHER"),
                    COMMON_NAME = gsub("\\(=", " \\(", COMMON_NAME)) %>%
      group_by_(.dots = dots) %>%
      dplyr::summarize(typeTotal = sum(VALUE, na.rm = TRUE))
    # 
    catchDy <- rbind(catchDy[catchDy[[type]] == "OTHER",],
                     catchDy[!catchDy[[type]] == "OTHER",])
    # 
    if(type == "COUNTRY"){
      counOrder <- unique(catchDy$COUNTRY)
      counOrder <- ifelse(counOrder %in% "OTHER", 
                          c("OTHER", counOrder[!counOrder %in% c("OTHER")]),
                          counOrder)
      # 
      counDy <- catchDy %>%
        ungroup() %>%
        select(COUNTRY, typeTotal, YEAR) %>%
        tidyr::spread(COUNTRY, typeTotal) %>%
        mutate(YEAR = as.Date(paste(YEAR, "-01",sep=""), format = "%Y-%M"))
      # 
      counDy <- counDy[,c("YEAR", counOrder)]
      # 
      counDyTS <- as.xts(counDy[ ,!(names(counDy) %in% c("YEAR"))],
                         dateFormat = "Date",
                         order.by = counDy$YEAR)
      # 
      counNames <- factor(names(counDyTS), levels = names(counDyTS))
      counCols <- c("grey40", colList[1:length(levels(counNames))-1])
      dyColors <- factor(counCols, levels = counCols)
      names(dyColors) <- levels(counNames)
      # 
      cody <- dygraph(counDyTS,
              main = paste0(gsub("27.", "", IA), " landings by country"),
              ylab = "Landings (tonnes)") %>%
        dyOptions(colors = levels(dyColors),
                  labelsKMB = "M", 
                  stackedGraph = TRUE) %>%
        dyHighlight(highlightCircleSize = 5, 
                    highlightSeriesBackgroundAlpha = .8,
                    # highlightSeriesOpts = list(fillGraph = TRUE),
                    hideOnMouseOut = FALSE) %>%
        # dyRangeSelector(height = 50) %>%
        dyLegend(labelsSeparateLines = FALSE)
    }
    if(type == "COMMON_NAME"){
      specOrder <- unique(catchDy$COMMON_NAME)
      specOrder <- ifelse(specOrder %in% "OTHER", 
                          c("OTHER", specOrder[!specOrder %in% c("OTHER")]),
                          specOrder)
      # 
      specDy <- catchDy %>%
        ungroup() %>%
        select(COMMON_NAME, typeTotal, YEAR) %>%
        tidyr::spread(COMMON_NAME, typeTotal) %>%
        mutate(YEAR = as.Date(paste(YEAR, "-01",sep=""), format = "%Y-%M"))
      specDy <- specDy[,c("YEAR", specOrder)]
      # 
      specDyTS <- as.xts(specDy[ ,!(names(specDy) %in% c("YEAR"))],
                       dateFormat = "Date",
                       order.by = specDy$YEAR)
      # 
      specNames <- factor(names(specDyTS), levels = names(specDyTS))
      specCols <- c("grey40", colList[1:length(levels(specNames))-1])
      dySplors <- factor(specCols, levels = specCols)
      names(dySplors) <- levels(specNames)
      # 
      spdy <- dygraph(specDyTS,
              main = paste0(gsub("27.", "", IA), " landings by species"),
              ylab = "Landings (tonnes)") %>%
        dyOptions(colors = levels(dySplors),
                  labelsKMB = "M", 
                  stackedGraph = TRUE) %>%
        dyHighlight(highlightCircleSize = 5, 
                    highlightSeriesBackgroundAlpha = .8,
                    hideOnMouseOut = FALSE) %>%
        # dyRangeSelector(height = 50) %>%
        dyLegend(width = 400,
                 labelsSeparateLines = FALSE)
    }
  }
  
  htmltools::tagList(list(cody, spdy))
# show(list(cody, spdy))
}
```


```{r echo=FALSE, fig.keep='all'}
# lapply(unique(allDat$ECOREGION), icesAreaDy, area = "ECOREGION")
# icesAreaDy(area = "ECOREGION", IA = "Celtic Seas")
```


<!-- ## Catch by ecoregion, aggregated by country and species (static plots) -->
```{r echo=FALSE, fig.width = 20, results='hide', fig.keep='all'}
# icesAreaPlot(area = "ECOREGION", IA = "Greater North Sea")
# icesAreaPlot(area = "ECOREGION", IA = "Greater North Sea",  type = "COUNTRY", fig.save = TRUE, fig.plot = FALSE)
lapply(unique(allDat$ECOREGION), icesAreaPlot, area = "ECOREGION", type = "COUNTRY", fig.save = TRUE, fig.plot = FALSE)
lapply(unique(allDat$ECOREGION), icesAreaPlot, area = "ECOREGION", type = "COMMON_NAME", fig.save = TRUE, fig.plot = FALSE)

```



<!-- ## Catch by ICES Area, aggregated by country and species (static plots) -->
```{r echo=FALSE, fig.width = 20, results='hide', fig.keep='all'}
# icesAreaPlot(area = "ECOREGION", IA = "Greater North Sea")
# icesAreaPlot(area = "ICES_Area", IA = "Celtic Seas")
# lapply(unique(allDat$ICES_Area[allDat$ECOREGION == "Celtic Seas"]), icesAreaPlot, area = "ICES_Area")
```

Created by <A HREF="mailto:scott.large@ices.dk?subject=Fisheries Overview plots">scott.large@ices.dk</A> with [knitr](http://yihui.name/knitr/), [dygraphs for R](https://rstudio.github.io/dygraphs/index.html), and [R](https://cran.r-project.org/)
